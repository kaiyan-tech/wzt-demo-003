# 开沿核心技术宪章

> **版本：** v1.3

> **最后更新：** 2025-12-07

> **关联文档：**`./开沿工程指导手册.md`（本地优先，随仓库版本同步）；外链备份：[钉钉文档](https://alidocs.dingtalk.com/i/nodes/KGZLxjv9VG06Exyah4aAM0jEJ6EDybno?utm_scene=team_space)（仅作镜像）

## 1. 设计哲学与原则

我们追求**极简架构**、**高效交付**、**严格治理**的平衡。

1. **前后端分离：** 前端（OSS 静态托管）与后端（FC/API）物理隔离，通过 API 契约通信。
2. **无服务优先：**
   - 优先使用托管服务（FC, RDS, OSS）。
   - **特例：** 生产环境后端配置 **1 个预留实例**以消除冷启动。
3. **不可变基础设施：**
   - 禁止 SSH 登录。
   - **IaC 闭环：** 所有基础设施变更（OSS, FC, RDS）必须收敛于`infra/`代码目录。严禁在云控制台"点点点"修改配置（仅允许查看状态和紧急回滚）。
4. **敏捷环境：**仅维护 **Production**（主干）一套云端环境，本地开发使用仓库内`docker-compose.yml`提供的独立 PostgreSQL 容器，拒绝低效的中间层。
   **单一事实来源：** 本文档是所有架构决策与开发规范的最高准则；具体操作步骤请参阅《开沿工程指导手册》（`./开沿工程指导手册.md`，外链备份：[钉钉文档](https://alidocs.dingtalk.com/i/nodes/KGZLxjv9VG06Exyah4aAM0jEJ6EDybno?utm_scene=team_space)）。

## 2. 整体架构与流量拓扑

### 2.1 技术栈概览

| **领域**   | **技术选型**                                | **关键说明**                              |
| ---------- | ------------------------------------------- | ----------------------------------------- |
| **前端**   | React 18 + TS + Vite + tailwind + shadcn/ui | 产物为纯静态文件，Hash 文件名             |
| **后端**   | Node.js (LTS) + NestJS                      | 单体应用部署为 FC 函数                    |
| **数据库** | PostgreSQL 17 + Prisma                      | 生产直连 RDS，开发使用本地 Docker Compose |
| **包管理** | **pnpm** (Workspace)                        | Monorepo 依赖管理核心工具                 |
| **CI/CD**  | GitHub Actions                              | 唯一流水线工具                            |

### 2.2 流量拓扑图

```mermaid
flowchart LR
  Browser[用户 Browser]
  OSS[OSS Bucket]
  FC[函数计算 FC]
  RDS[RDS PostgreSQL 17]

  Browser -->|1. 静态资源请求| OSS
  Browser -->|2. API 数据请求| FC --> RDS
```

### 2.3 域名管理

| **域名**         | **用途** | **解析目标**          |
| ---------------- | -------- | --------------------- |
| `app.kaiyan.net` | 前端 SPA | OSS Bucket 自定义域名 |
| `api.kaiyan.net` | 后端 API | FC HTTP 触发器        |

## 3. 仓库结构与分支策略

采用 **Monorepo** 结构，利用 **pnpm workspace** 解决依赖与共享问题。

### 3.1 目录结构与工具链

在根目录必须包含 `pnpm-workspace.yaml`。

```yaml
# pnpm-workspace.yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

**目录树：**

```text
root/
├── .github/workflows/   # CI/CD 定义
├── apps/
│   ├── frontend/        # React SPA (Vite)
│   └── backend/         # NestJS API (package.json 中引用 workspace:*)
├── packages/
│   └── shared/          # 共享类型定义 (DTOs, Types, Utils)
├── infra/               # 基础设施配置 (s.yaml) - 唯一的 Infra 变更源
│   ├── s.yaml           # Serverless Devs 配置（默认环境）
│   ├── s.prod.yaml      # 生产环境 Serverless Devs 配置
│   ├── dns/             # 域名解析配置
│   └── oss/             # OSS 配置模板
└── README.md
```

### 3.2 共享包规范（packages）

**定位：** 存放前后端共用的类型定义、DTO、工具函数。
**使用方式：**

```json
// apps/frontend/package.json 或 apps/backend/package.json
{
  "dependencies": {
    "@shared": "link:../../packages/shared"
  }
}
```

**发布策略：**

- **内部使用：** 通过`workspace:*`协议引用，无需发布到 npm。
- **版本管理：** 随主仓库统一版本，无需独立版本号。
- **变更规范：** 修改 shared 包时，需确保前后端同时兼容。

### 3.3 环境策略与数据库隔离

| **环境**     | **对应分支** | **触发条件** | **数据库策略**                                                                              |
| ------------ | ------------ | ------------ | ------------------------------------------------------------------------------------------- |
| **本地开发** | 任意分支     | 本地运行     | **使用仓库内 docker-compose 提供的独立 PostgreSQL 实例（默认配置见 docker-compose.yml）。** |
| **生产**     | Main         | Push / Merge | **独享阿里云 RDS Prod 库**。严格备份，原子发布。                                            |

### 3.4 分支命名规范

| **分支类型** | **命名格式**          | **示例**              |
| ------------ | --------------------- | --------------------- |
| **功能开发** | `feature/<简短描述>`  | `feature/user-auth`   |
| **Bug 修复** | `fix/<简短描述>`      | `fix/login-redirect`  |
| **紧急修复** | `hotfix/<简短描述>`   | `hotfix/api-crash`    |
| **重构优化** | `refactor/<简短描述>` | `refactor/db-queries` |

### 3.5 分支保护

**硬性规定：**`main`分支必须在 GitHub Settings 中开启保护：

- 禁止直接 Push。
- PR 合并前必须通过 CI Check (`lint + test + build`)。

## 4. 前端工程规范

### 4.1 核心规范

- **构建：** Vite 生成带 Hash 的文件名（如：`index.ab12.js`）。
- **测试：** 提交前必须通过`pnpm test`（单元测试）。

### 4.2 部署策略：覆盖式发布

采用简化的覆盖式发布，直接同步`dist/`目录到 OSS：

- **发布命令：**`ossutil sync dist/ oss://${bucket}/ --delete`
- **缓存策略：**使用 OSS 默认设置，或统一设为 `Cache-Control: max-age=86400`（1 天）
- **发布建议：**选择用户活跃度较低的时段（如工作日晚间）
  > **风险提示：** 发布期间（约 10~30 秒）若有用户正在访问，极小概率可能出现短暂白屏（旧 HTML 引用了已被删除的旧 JS）。用户刷新页面即可恢复。对于我们当前的中小企业内部管理场景，此风险可接受。

## 5. 后端工程规范

### 5.1 关键约束

1. **无状态：** FC 实例随时销毁，禁止内部存储 Session/File。
2. **数据库连接：** 生产环境直连 RDS PostgreSQL 17 实例（保持与 FC 同一 VPC 网段）；本地开发使用仓库内 docker-compose 启动的独立实例。
3. **安全：**
   - **JWT：**Access Token 严禁通过 URL Query 传递，必须使用 Header（`Authorization: Bearer`）或 Cookie。
   - **RAM 权限：CI/CD 使用的阿里云 AK 必须遵循最小权限原则**（仅限 OSS Put、FC Update、RDS DML），严禁使用 Root AK。
4. **预留实例：** 生产环境配置 **1 个预留实例**，消除冷启动延迟。

## 6. CI/CD 流水线详解

### 6.0 CI/CD 行为矩阵

| **触发来源**       | **变更范围**               | **前端流水线行为**                             | **后端流水线行为**                                          |
| ------------------ | -------------------------- | ---------------------------------------------- | ----------------------------------------------------------- |
| **PR（任意分支）** | `apps/*`                   | `lint` + `test` + `build` （仅 CI 检查）       | `lint` + `test` + `build` （仅 CI 检查）                    |
| **Push → main**    | `apps/frontend`            | `lint` + `test` + `build` -> **部署 Prod SPA** | （不触发）                                                  |
| **Push → main**    | `apps/backend` 或 `infra/` | （不触发）                                     | `lint` + `test` + `build` -> **完整后端发布流程（见 6.2）** |

**统一化设计原则：**

同一套流水线，部署由仓库变量 `ENABLE_DEPLOY` 控制：

| 仓库类型 | ENABLE_DEPLOY | 部署目标                             |
| -------- | ------------- | ------------------------------------ |
| 模板仓库 | 未设置        | 仅 lint/test/build，不触发部署       |
| 独立项目 | true          | 生产部署（OSS + FC），含数据库迁移等 |

> 初始化脚本会在独立项目仓库写入 `ENABLE_DEPLOY=true`；模板仓库不设置该变量，避免模板迭代阶段占用云端资源。

### 6.1 前端流水线（`frontend-pipeline.yml`）

**核心步骤：** 检查 (`lint && typecheck && test`) -> Build -> Deploy Assets（Immutable）-> Deploy HTML（No-Cache）。

### 6.2 后端流水线（`backend-pipeline.yml`）

生产部署设计采用 **"先版本，后切流"** 模式，但由于 FC3 的限制，实际流程有所简化。

> **FC3 限制说明**：阿里云 FC3 组件当前不返回版本号，无法使用传统的版本/别名机制进行流量切换。详见 [FC 部署补丁文档](./FC部署补丁.md#已知限制)。

**实际执行流程：**

1. **CI 检查：** `pnpm lint && pnpm test`。
2. **部署代码：**
   - 使用 Serverless Devs 发布代码到 FC3
   - 由于 FC3 不支持版本管理，部署后立即生效（HTTP 触发器自动指向最新代码）
3. **数据库迁移（向前兼容）：**
   - 调用 FC 的内部接口 `/api/internal/db-migrate`，由 FC 在 VPC 内执行 `prisma migrate deploy`
   - **原则：** 数据库变更必须**向前兼容**，确保回滚时旧代码仍可运行
4. **冒烟测试（验证）：**
   - 对部署后的 FC URL 运行健康检查（`/api/health`）
   - 若测试失败，需要通过 Git revert + 重新部署回滚
5. **流量切换（跳过）：** - 由于 FC3 不返回版本号，`s alias publish` 步骤被跳过 - FC3 HTTP 触发器默认指向最新部署，无需手动切流
   **回滚策略：**

- 代码问题：Git revert 相关 commit，重新触发流水线
- 紧急情况：在阿里云 FC 控制台手动回滚到之前的部署（如有历史记录）
- 数据库问题：需手动执行反向迁移（依赖"向前兼容"原则，通常无需回滚数据库）

## 7. 观测与告警

> 详细配置步骤请参阅《开沿工程指导手册》（`./开沿工程指导手册.md`；外链备份：[钉钉文档](https://alidocs.dingtalk.com/i/nodes/KGZLxjv9VG06Exyah4aAM0jEJ6EDybno?utm_scene=team_space&iframeQuery=anchorId%3Duu_migb2fnlx1gequj7s3)）第五部分。

### 7.1 日志规范

- **后端：** 统一使用 JSON 格式输出日志，必须包含 `requestId`、`level`、`userId`，日志自动采集至 SLS。
- **前端：** 接入 Sentry 捕获 JS 运行时错误和 API 请求失败。

### 7.2 核心告警阈值

| **级别** | **指标**           | **阈值**            |
| -------- | ------------------ | ------------------- |
| **严重** | API 5xx 错误率     | > 5%（持续 1 分钟） |
| **严重** | P95 响应时间       | > 2s（持续 5 分钟） |
| **警告** | 数据库连接数使用率 | > 80%               |

## 8. 配置与密钥管理

### 8.1 必需 Secrets 清单（GitHub Actions）

```bash
# 权限 (最小权限 RAM)
ALIYUN_ACCESS_KEY_ID
ALIYUN_ACCESS_KEY_SECRET

# 基础设施
OSS_BUCKET_PROD
FC_SERVICE_NAME
VPC_ID
VSWITCH_ID
SECURITY_GROUP_ID

# 应用配置
DATABASE_URL         # 生产数据库：postgresql://user:pass@rds-endpoint:5432/db?schema=public
JWT_SECRET
MIGRATION_TOKEN_PROD     # FC 内部迁移接口校验 Token（生产）
MIGRATION_ENDPOINT_PROD  # 生产迁移接口 URL，例：https://<fc-url>/api/internal/db-migrate

# 初始化方式：git clone 模板后运行 ./scripts/setup.sh，交互式收集参数，自动同步 GitHub Secrets 并首推 main。
# 详见 docs/快速开始.md
```

## 9. 应急与回滚指南

> 详细操作步骤请参阅《开沿工程指导手册》（`./开沿工程指导手册.md`；外链备份：[钉钉文档](https://alidocs.dingtalk.com/i/nodes/KGZLxjv9VG06Exyah4aAM0jEJ6EDybno?utm_scene=team_space&iframeQuery=anchorId%3Duu_migb2fne43xyusr237o)）第四部分。

### 9.1 前端回滚

- **操作：**在 GitHub Actions 中 **Re-run** 上一次成功的 Deploy Job。
- **原理：**从旧 commit 重新构建并覆盖部署，耗时约 1 分钟。

### 9.2 后端回滚

> **FC3 限制说明**：由于 FC3 不支持版本/别名管理（详见 6.2 节），无法实现秒级别名切换回滚。

- **场景：**代码逻辑错误导致 API 崩溃。
- **操作：**
  1. Git revert 问题 commit：`git revert <commit-hash>`
  2. 推送到 main 触发重新部署：`git push origin main`
  3. 等待 CI/CD 流水线完成（约 3-5 分钟）
- **紧急情况：**在阿里云 FC 控制台查看函数历史记录，手动回滚到之前的部署版本（如可用）。
- **注意：**如果涉及数据库已迁移，依赖"向前兼容"原则保证旧代码可用；若数据库变更破坏了兼容性，需先手动恢复数据库。

## 附录 A：术语表

> 术语表已统一收录于《开沿工程指导手册》附录 C，请参阅 [开沿工程指导手册 - 附录 C：术语表](./开沿工程指导手册.md#附录-c术语表)。
