# 数据库迁移规则

> 本文档更新了本地 Docker 开发、CI/CD 以及生产数据库的迁移/种子流程。

## 环境说明

| 环境     | 数据库                | 用途               |
| -------- | --------------------- | ------------------ |
| 本地开发 | Docker PostgreSQL     | 开发调试、单元测试 |
| CI 测试  | GitHub Actions 容器   | 自动化测试         |
| 生产环境 | 阿里云 RDS PostgreSQL | 线上服务           |

## 本地开发

### 启动数据库

```bash
pnpm db:start      # 启动 Docker PostgreSQL
pnpm db:setup      # 启动 + 迁移 + seed（首次使用）
```

### 创建迁移

```bash
pnpm db:migrate    # 修改 schema.prisma 后生成迁移文件
```

### 重置数据库

```bash
pnpm db:reset      # 清空数据并重新初始化
```

## 生产部署

- 推送到 main 自动触发 CI/CD。
- 迁移通过 `/api/internal/db-migrate` 端点执行。
- 种子通过 `/api/internal/db-seed` 端点执行（幂等）。
- 开发者无需直接接触生产数据库。

## 迁移规范

1. 所有 schema 变更必须通过 `pnpm db:migrate` 生成迁移文件并提交到 Git。
2. 迁移文件必须提交到仓库，禁止只改 `schema.prisma` 不提交迁移。
3. 禁止直接修改生产数据库，仅允许流水线调用迁移/种子接口。
4. 迁移命名使用描述性英文，下划线分隔（如 `add_user_avatar`）。

## 风险与注意事项

| 风险                     | 影响           | 缓解措施                                  |
| ------------------------ | -------------- | ----------------------------------------- |
| 开发者没有安装 Docker    | 无法本地开发   | `setup.sh` 检查 Docker 并提示安装         |
| 现有项目迁移             | 旧配置不兼容   | 提供迁移指南，手动更新 `.env`             |
| 生产 seed 失败           | 应用初始化失败 | seed 使用 upsert 保证幂等，失败不阻塞部署 |
| 本地与生产 schema 不一致 | 部署失败       | CI 先测试再部署，保证迁移正确             |

## 流程对比

| 场景       | 流程                                                              |
| ---------- | ----------------------------------------------------------------- |
| 本地开发   | `pnpm db:setup` → 本地 Docker PostgreSQL → 开发                   |
| 项目初始化 | `./scripts/setup.sh` → 输入生产库 URL → 部署 FC → 启动本地 Docker |
| CI/CD      | 部署 → 迁移生产库 → Seed 生产库（幂等）→ 完成                     |
