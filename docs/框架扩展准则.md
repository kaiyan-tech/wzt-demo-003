# 开沿框架扩展准则

> **版本：** v1.0 | **更新：** 2025-12-09
> **定位：** 《开沿核心技术宪章》的实施细则。宪章定义"为什么"，本文档定义"怎么做"。

## 1. 核心原则

1. 模式一致性：遵循现有模式，除非有充分理由重构
2. 单一职责：每个文件、组件、函数只做一件事
3. 类型先行：先在 shared 定义类型，再实现功能
4. 权限内聚：权限定义集中在 shared，校验集中在 Guard
5. 最小依赖：能用标准库就不引入新依赖

## 2. 架构要点

### 2.1 数据流

前端：Page → useXxxQuery (React Query) → xxxApi (lib/api) → HTTP Client
后端：Controller (@RequirePermissions) → Service (extends ScopedService) → Prisma

### 2.2 权限聚合规则

- **权限**：多角色取 **UNION**（合并去重）
- **数据范围**：多角色取 **MAX**（最宽松）
- 优先级：`ALL > ORG_TREE > ORG > SELF`

### 2.3 数据范围过滤

`ScopedService.getScopeFilter()` 自动生成 Prisma 查询条件：

| 范围       | 过滤条件                                     |
| ---------- | -------------------------------------------- |
| `ALL`      | `{}`                                         |
| `ORG_TREE` | `{ organization: { path: { startsWith } } }` |
| `ORG`      | `{ orgId: user.orgId }`                      |
| `SELF`     | `{ createdBy: user.id }`                     |

## 3. 模块扩展检查清单

添加新业务模块（如"项目管理"）时，按顺序完成：

### 共享包 (packages/shared)

| 步骤 | 文件               | 操作                            |
| ---- | ------------------ | ------------------------------- |
| 1    | `permissions.ts`   | 添加 `Permission` 枚举值        |
| 2    | `permissions.ts`   | 添加 `PermissionModule` 枚举值  |
| 3    | `permissions.ts`   | 添加 `PERMISSION_METADATA` 条目 |
| 4    | `types/*.types.ts` | 定义 DTO 类型（新建文件）       |
| 5    | `index.ts`         | 导出新类型                      |

### 后端 (apps/backend)

| 步骤 | 文件                           | 操作                                        |
| ---- | ------------------------------ | ------------------------------------------- |
| 6    | `prisma/schema.prisma`         | 定义数据模型，执行迁移                      |
| 7    | `src/{module}/dto/`            | 创建 DTO（含 class-validator）              |
| 8    | `src/{module}/*.service.ts`    | 创建 Service，**必须继承 ScopedService**    |
| 9    | `src/{module}/*.controller.ts` | 创建 Controller，使用 `@RequirePermissions` |
| 10   | `src/{module}/*.module.ts`     | 创建 Module                                 |
| 11   | `src/app.module.ts`            | 注册 Module                                 |

### 前端 (apps/frontend)

| 步骤 | 文件                       | 操作                             |
| ---- | -------------------------- | -------------------------------- |
| 12   | `lib/api/{module}.ts`      | 创建 API 请求函数                |
| 13   | `hooks/api/use{Module}.ts` | 创建 React Query Hooks           |
| 14   | `features/{module}/`       | 创建页面和表单组件               |
| 15   | `App.tsx`                  | 添加路由（含 `PermissionRoute`） |

**参考实现**：`role` 模块（后端 `src/role/`，前端 `features/roles/`）

## 4. 文件放置规则

### 前端

| 类型        | 位置                 | 示例                |
| ----------- | -------------------- | ------------------- |
| 页面组件    | `features/{模块}/`   | `ProjectPage.tsx`   |
| 业务表单    | `features/{模块}/`   | `ProjectForm.tsx`   |
| 通用组件    | `components/{分类}/` | `ConfirmDialog.tsx` |
| API 请求    | `lib/api/`           | `projects.ts`       |
| Query Hooks | `hooks/api/`         | `useProjects.ts`    |
| 通用 Hooks  | `hooks/`             | `useConfirm.ts`     |
| Context     | `contexts/`          | `AuthContext.tsx`   |

### 后端

| 类型       | 位置                     | 示例                       |
| ---------- | ------------------------ | -------------------------- |
| DTO        | `src/{模块}/dto/`        | `create-project.dto.ts`    |
| Service    | `src/{模块}/`            | `project.service.ts`       |
| Controller | `src/{模块}/`            | `project.controller.ts`    |
| Module     | `src/{模块}/`            | `project.module.ts`        |
| 通用守卫   | `src/common/guards/`     | `permissions.guard.ts`     |
| 通用装饰器 | `src/common/decorators/` | `permissions.decorator.ts` |

### 决策流程

是页面？ → features/
是通用组件（3+处复用）？ → components/
是 API 相关？ → lib/api/ 或 hooks/api/
都不是？ → 放在使用它的模块内

## 5. 命名约定

| 类型          | 格式                   | 示例                  |
| ------------- | ---------------------- | --------------------- |
| 页面组件      | `{Entity}Page`         | `ProjectPage`         |
| 表单组件      | `{Entity}Form`         | `ProjectForm`         |
| Query Hook    | `use{Entity}Query`     | `useProjectsQuery`    |
| Mutation Hook | `use{Entity}Mutations` | `useProjectMutations` |
| API 对象      | `{entity}Api`          | `projectApi`          |
| 权限枚举值    | `{MODULE}_{ACTION}`    | `PROJECT_READ`        |
| 权限字符串    | `{module}:{action}`    | `project:read`        |
| 后端 DTO      | `{Action}{Entity}Dto`  | `CreateProjectDto`    |

## 6. 关键模式

### 6.1 后端 Service 必须继承 ScopedService

```typescript
// 正确
export class ProjectService extends ScopedService {
  async findAll(user: CurrentUser) {
    const filter = this.getScopeFilter(user, 'orgId', 'createdBy');
    return this.prisma.project.findMany({ where: filter });
  }
}

// 错误：手动实现数据范围过滤
```

### 6.2 前端权限控制使用专用组件

```typescript
// UI 控制
<PermissionGuard permission={Permission.XXX}>...</PermissionGuard>
<PermissionButton permission={Permission.XXX}>操作</PermissionButton>

// 路由控制
<PermissionRoute permission={Permission.XXX}><Page /></PermissionRoute>
```

### 6.3 编辑状态使用 key 强制重置

```typescript
const [editing, setEditing] = useState<Entity | null>(null);

<Form key={editing?.id ?? 'new'} entity={editing} />
```

### 6.4 删除确认使用 useConfirm + ConfirmDialog

```typescript
const deleteConfirm = useConfirm<Entity>();

// 触发
<Button onClick={() => deleteConfirm.confirm(entity)}>删除</Button>

// 弹窗
<ConfirmDialog
  open={deleteConfirm.state.open}
  onOpenChange={(open) => !open && deleteConfirm.reset()}
  onConfirm={handleDelete}
  variant="destructive"
/>
```

### 6.5 Mutation 成功后失效查询

```typescript
const create = useMutation({
  mutationFn: projectApi.create,
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['projects'] });
  },
});
```

## 7. 反模式警告

### 禁止

| 反模式                         | 正确做法                        |
| ------------------------------ | ------------------------------- |
| 硬编码权限字符串 `'user:read'` | 使用枚举 `Permission.USER_READ` |
| Service 不继承 ScopedService   | 继承并使用 `getScopeFilter()`   |
| API 请求直接写在组件中         | 使用 `lib/api/` + `hooks/api/`  |
| 页面放在 `components/`         | 页面放 `features/`              |
| 通用组件放在 `features/`       | 通用组件放 `components/`        |
| `useEffect` 同步状态           | 直接使用原始状态                |
| Mutation 后手动更新缓存        | 使用 `invalidateQueries`        |
| Controller 中写业务逻辑        | 业务逻辑放 Service              |
| 前端只做 UI 隐藏不做后端校验   | 必须后端 `@RequirePermissions`  |

### 避免

| 情况             | 建议                         |
| ---------------- | ---------------------------- |
| 单处使用就抽组件 | 3+ 处复用再抽取              |
| 过度嵌套 Context | 页面状态用 useState          |
| 引入新状态管理库 | 优先用 React Query + Context |

## 8. 快速参考

### 权限格式

```
{module}:{action}
常用 action: read, create, update, delete, assign, export
示例: project:read, role:assign, report:export
```

### 多权限组合

```typescript
// 后端：AND 逻辑
@RequirePermissions(Permission.A, Permission.B)

// 前端：AND（默认）
<PermissionGuard permission={[Permission.A, Permission.B]}>

// 前端：OR
<PermissionGuard permission={[Permission.A, Permission.B]} mode="any">
```

### 数据范围扩展

如需新增数据范围等级，需修改：

1. `packages/shared/src/permissions.ts` - DataScope 枚举
2. `apps/backend/src/common/scoped.service.ts` - getScopeFilter 方法
3. `apps/backend/src/auth/jwt.strategy.ts` - 优先级映射
4. `apps/backend/prisma/schema.prisma` - DataScope 枚举
