# 开沿工程指导手册

> **版本：** v2.2

> **最后更新：** 2025-12-08
>
> **关联文档：**`./开沿核心技术宪章.md`（本地优先）；外链备份：[钉钉文档](https://alidocs.dingtalk.com/i/nodes/mExel2BLV5vaNjMEILD0OEMKJgk9rpMq?utm_scene=team_space)（架构决策与规范准则请参阅该宪章）

# 第一部分：开始之前

> **目标：** 准备好工具链和阿里云环境，为 `./scripts/setup.sh` 一键初始化做好准备。

## 1.1 工具链准备

### 必需工具

| 工具                | 最低版本 | 安装方式                            | 用途           |
| ------------------- | -------- | ----------------------------------- | -------------- |
| **Node.js**         | 22.0.0   | [nodejs.org](https://nodejs.org/)   | 运行时环境     |
| **pnpm**            | 10.0.0   | `npm install -g pnpm`               | 包管理器       |
| **git**             | -        | 系统自带或 brew/apt                 | 版本控制       |
| **GitHub CLI**      | -        | `brew install gh`                   | GitHub 操作    |
| **aliyun CLI**      | -        | `brew install aliyun-cli`           | 阿里云资源管理 |
| **Serverless Devs** | 3.x      | `npm install -g @serverless-devs/s` | FC 部署工具    |

### 账号准备

1. **科学上网：** 可正常访问 GitHub / Google
2. **GitHub 账号：** 加入组织，执行 `gh auth login` 绑定账号
3. **阿里云账号：** 用于创建 RAM 用户和云资源

## 1.2 阿里云环境准备

> `./scripts/setup.sh` 会自动创建 OSS Bucket、部署 FC 函数、同步 GitHub Secrets。
> 但以下资源需要**提前手动准备**，因为它们涉及企业级安全策略或无法自动化创建。

### 1.2.1 创建 RAM 用户（部署专用）

为了安全，禁止在 CI/CD 中使用主账号 AK。

1. 登录阿里云 RAM 控制台
2. 创建用户，命名如 `github-actions-deployer`
3. 授予以下权限：
   - `AliyunOSSFullAccess`（前端静态资源管理）
   - `AliyunFCFullAccess`（后端函数发布）
   - `AliyunRDSFullAccess`（数据库迁移与连接）
4. 创建 AccessKey，**妥善保存** `AccessKey ID` 和 `Secret`

### 1.2.2 准备 RDS 数据库（生产）

本地开发统一使用仓库内 `docker-compose.yml` 提供的 PostgreSQL 容器，**无需单独申请 RDS 开发库**。仅需准备生产库：

| 数据库     | 用途        | 命名建议         |
| ---------- | ----------- | ---------------- |
| **生产库** | FC 线上使用 | `{project}_prod` |

**获取连接串：**

```
postgresql://user:pass@rds-endpoint:5432/dbname?schema=public
```

**注意事项：**

- 将 FC 所在的 VPC 网段加入 RDS 白名单
- 记录 RDS 实例的**内网地址**（供 FC 使用）
- 本地开发无需配置 RDS 白名单，直接使用 `docker-compose` 启动的本地数据库

### 1.2.3 记录 VPC 网络信息

FC 必须与 RDS 在同一 VPC 内才能访问数据库。请记录以下信息：

| 配置项                | 示例值                      | 获取位置            |
| --------------------- | --------------------------- | ------------------- |
| **VPC ID**            | `vpc-wz99ws34443mvleb62x86` | VPC 控制台          |
| **VSwitch ID**        | `vsw-wz9223bclrrg7lhvv8gml` | VPC 控制台 - 交换机 |
| **Security Group ID** | `sg-wz97utch71p1mo0etbg9`   | ECS 控制台 - 安全组 |

> **确保 VSwitch 与 RDS 在同一可用区，Security Group 允许访问 RDS 端口（5432）。**

### 1.2.4 汇总清单

运行 `./scripts/setup.sh` 前，请确认已准备好以下信息（对应 `scripts/setup.env` 配置项）：

| 配置项                     | 必填 | 说明                           |
| -------------------------- | ---- | ------------------------------ |
| `PROJECT_NAME`             | 是   | 项目名称                       |
| `GITHUB_ORG`               | 是   | GitHub 组织名                  |
| `ALIYUN_ACCESS_KEY_ID`     | 是   | RAM 用户 AccessKey ID          |
| `ALIYUN_ACCESS_KEY_SECRET` | 是   | RAM 用户 AccessKey Secret      |
| `DATABASE_URL`             | 是   | 生产数据库连接串               |
| `REGION`                   | 否   | 阿里云地域（默认 cn-shenzhen） |
| `VPC_ID`                   | 是   | VPC ID                         |
| `VSWITCH_ID`               | 是   | VSwitch ID                     |
| `SECURITY_GROUP_ID`        | 是   | Security Group ID              |

# 第二部分：一键初始化

> **核心工具：** 模板内置的 `./scripts/setup.sh` 脚本会自动完成从配置到生产部署的全部工作。
> 快速开始参见 [快速开始](./快速开始.md)。

## 2.1 克隆模板

```bash
git clone https://github.com/kaiyan-tech/ky-framework.git <project-name>
cd <project-name>
```

## 2.2 配置参数（二选一）

### 方式一：配置文件（推荐，免交互）

```bash
cp scripts/setup.env scripts/setup.env
# 编辑 setup.env 填写所有参数
```

配置文件示例：

```bash
PROJECT_NAME=my-project
GITHUB_ORG=kaiyan-tech
ALIYUN_ACCESS_KEY_ID=LTAI5t***
ALIYUN_ACCESS_KEY_SECRET=***
DATABASE_URL=postgresql://user:pass@rds-internal:5432/prod?schema=public
REGION=cn-shenzhen
VPC_ID=vpc-xxx
VSWITCH_ID=vsw-xxx
SECURITY_GROUP_ID=sg-xxx
```

### 方式二：交互式输入

直接运行脚本，按提示输入参数。

## 2.3 运行初始化

```bash
./scripts/setup.sh
```

### 自动完成的工作

| 步骤                   | 说明                                     |
| ---------------------- | ---------------------------------------- |
| 1. 重置 Git 历史       | 清除模板 commit，创建全新仓库            |
| 2. 安装依赖            | 执行 `pnpm install`                      |
| 3. 初始化本地数据库    | 启动 Docker PostgreSQL，执行迁移和种子   |
| 4. 创建 OSS            | 创建生产环境 Bucket，配置静态网站和 CORS |
| 5. 部署 FC             | 构建后端并部署到函数计算                 |
| 6. 生成 .env           | 写入前后端环境变量文件                   |
| 7. 创建 GitHub 仓库    | 在组织下创建仓库                         |
| 8. 同步 GitHub Secrets | 将所有配置写入 Secrets                   |
| 9. 推送代码            | 首次推送触发 CI/CD 流水线                |

## 2.4 验证初始化结果

初始化完成后，执行以下检查：

1. **本地启动验证：**

   ```bash
   cd <project-name>
   pnpm --filter backend start:dev   # 后端 http://localhost:3000
   pnpm --filter frontend dev        # 前端 http://localhost:5173
   ```

2. **GitHub 验证：**
   - 访问 `https://github.com/<org>/<project>`
   - 检查 CI/CD 流水线是否运行成功
   - 检查 Settings -> Secrets 是否已同步

3. **云端验证：**
   - FC 控制台：确认函数已部署
   - OSS 控制台：确认 Bucket 已创建

## 2.5 手动补充配置（可选）

以下配置需要在初始化后手动完成：

### OSS 绑定自定义域名

OSS 默认域名无法直接浏览器访问，需绑定自定义域名（如 `app.kaiyan.net`）：

1. 登录 OSS 控制台 -> 传输管理 -> 域名管理
2. 绑定自定义域名
3. 在域名服务商添加 CNAME 记录

### FC 配置预留实例

生产环境建议配置 1 个预留实例以消除冷启动：

1. 登录 FC 控制台 -> 函数管理
2. 进入预留配置 -> 添加预留实例

### HTTPS 证书

- 可使用阿里云免费 SSL 证书或 Let's Encrypt
- 需在 OSS 和 FC 控制台分别配置

# 第三部分：日常开发工作流

> **时间线：** 本地开发 → 提交分支 → PR CI 校验 → Review 通过 → 合并 main → 生产发布

## 3.1 开发与提交流程

### 1. 创建分支

遵循命名规范：

```bash
git checkout -b feature/<desc>   # 新功能
git checkout -b fix/<desc>       # Bug 修复
git checkout -b hotfix/<desc>    # 紧急修复
```

### 2. 本地开发

```bash
pnpm --filter backend start:dev   # 后端（连接本地 Docker 数据库）
pnpm --filter frontend dev        # 前端
```

### 3. 提交前检查

```bash
pnpm lint       # 代码规范检查
pnpm test       # 单元测试
pnpm typecheck  # TypeScript 类型检查（可选）
```

### 4. 提交与推送

```bash
git add .
git commit -m "feat: 添加用户认证功能"
git push origin <your-branch>
```

### 5. 创建 PR

命令行方式：

```bash
gh pr create --base main --head <your-branch> --title "feat: xxx" --body "..."
```

或在 GitHub 网页点击 "Compare & pull request"。

## 3.2 PR CI 校验

PR 创建/更新时自动触发 CI 检查：

| 流水线   | 检查内容                        |
| -------- | ------------------------------- |
| **前端** | lint + typecheck + test + build |
| **后端** | lint + typecheck + test + build |

> **注意：** PR 阶段只做 CI 检查，不会部署到任何环境。本地调试使用 Docker 数据库已足够高效。

## 3.3 合并与上线

### 合并条件

- PR Review 通过
- CI 检查全绿

### 合并方式

点击 **"Squash and merge"** 到 main（禁止直接 push main）。

### 自动发布流程

合并到 main 后自动触发：

**前端流水线：**

1. build 构建产物
2. 覆盖式同步到生产 OSS

**后端流水线：**

1. build 构建后端
2. 部署到 FC
3. 调用 `/api/internal/db-migrate` 执行数据库迁移
4. 冒烟测试 `/api/health`

# 第四部分：运维监控与紧急回滚

> **场景：** 生产环境出现故障时，保持冷静，按以下逻辑操作。

## 4.1 故障分诊

| 现象                                 | 判断       | 处理方向 |
| ------------------------------------ | ---------- | -------- |
| 白屏、样式错乱、点击无反应           | 前端问题   | 见场景 A |
| 页面正常，但提示"网络错误"、500 报错 | 后端问题   | 见场景 B |
| 数据写入失败、查询超时               | 数据库问题 | 见场景 C |

## 4.2 执行回滚

### 场景 A：前端回滚（耗时约 1 分钟）

前端采用覆盖式发布，回滚需要重新构建旧版本：

1. 打开 GitHub Actions -> **前端流水线**
2. 找到**上一次成功**的 Run 记录
3. 点击 **"Re-run all jobs"**
4. 等待重新构建并部署

### 场景 B：后端回滚

**方式一：Git revert（推荐）**

```bash
git revert <commit-hash>
git push origin main
```

等待 CI/CD 自动重新部署。

**方式二：FC 控制台回滚（紧急）**

1. 登录阿里云函数计算控制台
2. 查看函数历史部署版本
3. 手动回滚到之前的版本（如可用）

### 场景 C：数据库回滚（高危）

1. **严禁**直接在控制台修改 Schema
2. 优先回滚后端代码以停止错误调用
3. 编写逆向 Migration 脚本，通过正常发布流程修复

> **重要：** 数据库变更必须**向前兼容**，确保回滚代码时旧代码仍可运行。

## 4.3 发布后验证

每次上线后，务必进行冒烟测试：

1. **检查 CI 状态：** 确保流水线全绿
2. **线上验证：** 访问生产域名，执行核心业务操作
3. **监控检查：** 观察错误率和响应时间是否异常

# 第五部分：日志与监控规范

> 详见[《开沿核心技术宪章》](./开沿核心技术宪章.md)第 7 节（外链备份：[钉钉文档](https://alidocs.dingtalk.com/i/nodes/mExel2BLV5vaNjMEILD0OEMKJgk9rpMq?utm_scene=team_space&iframeQuery=anchorId%3Duu_migb3frtd681mdg8ak5)）。

## 5.1 后端日志规范

统一使用 JSON 格式输出，便于 SLS 自动采集：

```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "info | warn | error",
  "requestId": "fc-request-id",
  "userId": "user-123",
  "message": "操作描述",
  "context": {}
}
```

## 5.2 前端错误监控（Sentry）

1. 在 Sentry 创建项目，获取 DSN
2. 安装 SDK：`pnpm --filter frontend add @sentry/react`
3. 配置 `VITE_SENTRY_DSN` 环境变量

## 5.3 告警规则

| 级别     | 指标               | 阈值  | 持续时间 |
| -------- | ------------------ | ----- | -------- |
| **严重** | API 5xx 错误率     | > 5%  | 1 分钟   |
| **严重** | P95 响应时间       | > 2s  | 5 分钟   |
| **警告** | 数据库连接数使用率 | > 80% | 5 分钟   |

配置位置：

- FC：函数计算控制台 -> 监控 -> 告警规则
- RDS：RDS 控制台 -> 监控与报警 -> 报警规则

# 附录 A：常用命令速查表

| 场景               | 命令                              | 备注                |
| ------------------ | --------------------------------- | ------------------- |
| **安装依赖**       | `pnpm install`                    | 根目录执行          |
| **前端开发**       | `pnpm --filter frontend dev`      | 默认 5173 端口      |
| **后端开发**       | `pnpm --filter backend start:dev` | 默认 3000 端口      |
| **静态检查**       | `pnpm lint`                       | ESLint + TypeScript |
| **全量测试**       | `pnpm test`                       | 所有单元测试        |
| **类型检查**       | `pnpm typecheck`                  | TypeScript 类型检查 |
| **DB Client 生成** | `npx prisma generate`             | 修改 Schema 后执行  |
| **DB 结构同步**    | `npx prisma db push`              | **仅限开发环境**    |
| **DB 迁移生成**    | `npx prisma migrate dev`          | **提交前必做**      |
| **清理缓存**       | `pnpm store prune`                | 依赖报错时使用      |

# 附录 B：项目结构概览

```text
project/
├── apps/
│   ├── frontend/        # React + Vite + Tailwind + shadcn/ui
│   └── backend/         # NestJS（Serverless 适配）
├── packages/
│   └── shared/          # 前后端共用 DTO / Types / Utils
├── infra/               # 基础设施配置（IaC）
│   ├── s.yaml           # Serverless Devs 配置（默认环境）
│   ├── s.prod.yaml      # 生产环境 Serverless Devs 配置
│   └── oss/             # OSS 配置模板
├── .github/workflows/   # CI/CD 流水线
└── docs/                # 文档
```

# 附录 C：术语表

| 术语     | 全称/释义                                                         |
| -------- | ----------------------------------------------------------------- |
| FC       | Function Compute，阿里云函数计算服务                              |
| OSS      | Object Storage Service，阿里云对象存储                            |
| RDS      | Relational Database Service，阿里云关系型数据库                   |
| IaC      | Infrastructure as Code，基础设施即代码                            |
| SSOT     | Single Source of Truth，单一事实来源                              |
| Monorepo | 单一代码仓库管理多个项目/包的模式                                 |
| SPA      | Single Page Application，单页应用                                 |
| DTO      | Data Transfer Object，数据传输对象                                |
| RAM      | Resource Access Management，阿里云访问控制                        |
| AK       | Access Key，访问密钥                                              |
| PR       | Pull Request，拉取请求                                            |
| CI/CD    | Continuous Integration / Continuous Deployment，持续集成/持续部署 |
| VPC      | Virtual Private Cloud，虚拟私有云                                 |
| SLS      | Simple Log Service，阿里云日志服务                                |
