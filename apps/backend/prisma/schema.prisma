// Prisma Schema
// 参考：《开沿核心技术宪章》2.1 节 - 数据库采用 RDS PostgreSQL 17 + Prisma

generator client {
  provider      = "prisma-client-js"
  // native: 本地开发，debian-openssl-3.0.x: 阿里云 FC custom.debian12 运行时
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 组织模型（部门/租户）- 使用物化路径优化树查询
model Organization {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  parentId  String?  @map("parent_id")
  parent    Organization? @relation("OrgHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children  Organization[] @relation("OrgHierarchy")
  path      String   // 物化路径，例如 '/1/2/3/'
  level     Int      @default(0)
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users     User[]

  @@index([path])
  @@index([parentId])
  @@map("organizations")
}

// 用户模型
model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  name         String
  phone        String?
  email        String?  @unique
  avatar       String?
  status       UserStatus @default(ACTIVE)
  orgId        String   @map("org_id")
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  roles        UserRole[]
  auditLogs    AuditLog[]

  @@index([orgId])
  @@index([username])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
}

// 角色模型
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  dataScope   DataScope @default(SELF) @map("data_scope")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

enum DataScope {
  ALL       // 全部数据
  ORG_TREE  // 本部门及子部门
  ORG       // 本部门
  SELF      // 仅本人
}

// 权限模型
model Permission {
  code        String   @id // 例如 'user:read'
  module      String   // 模块名，例如 'user'
  description String
  createdAt   DateTime @default(now()) @map("created_at")

  roles       RolePermission[]

  @@index([module])
  @@map("permissions")
}

// 用户-角色关联表（多对多）
model UserRole {
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@id([userId, roleId])
  @@map("user_roles")
}

// 角色-权限关联表（多对多）
model RolePermission {
  roleId         String     @map("role_id")
  permissionCode String     @map("permission_code")
  role           Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission     Permission @relation(fields: [permissionCode], references: [code], onDelete: Cascade)
  createdAt      DateTime   @default(now()) @map("created_at")

  @@id([roleId, permissionCode])
  @@map("role_permissions")
}

// 审计日志模型（不可变）
model AuditLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Restrict)
  action    String   // 操作描述
  method    String   // HTTP 方法
  path      String   // 请求路径
  params    Json?    // 请求参数（JSON）
  ip        String   // IP 地址
  duration  Int      // 耗时（毫秒）
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
